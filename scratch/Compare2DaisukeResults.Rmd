---
title: "Compare to Daisuke's Results"
author: "Derek H. Ogle"
date: "August 8, 2017"
output: 
  pdf_document: 
    fig_height: 3.5
    fig_width: 3.5
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo=TRUE,comment="")
library(FSA)
library(dplyr)
library(magrittr)
library(readxl)
library(plotrix)
library(captioner)
figs <- captioner("Figure")
source("../code/helpers/productionHelpers.R")
```


## Initial Comparison (to Daisuke's Compiled Results)
```{r readResults, echo=FALSE}
## Need to set working directory to source file if analyzing "on-the-fly"
DGres <- read_excel("zzzOld_FromDaisuke/Daisuke Production Estimates.xlsx") %>%
  rename(wbic=WBIC,year=Year,wbic_year=WBIC_Year,P="P (kg/ha/y)",B="B (kg/ha)") %>%
  mutate(PB=P/B) %<>%
  select(wbic_year,wbic,year,P,B,PB)
WYs_DG <- unique(DGres$wbic_year)

DOres <- read.csv("../results/PB_SM_IW.csv",stringsAsFactors=FALSE) %>%
  mutate(PB=P/B)
WYs_DO1 <- unique(DOres$wbic_year)
DOres %<>% filterD(use=="yes")
WYs_DO <- unique(DOres$wbic_year)

DODGres <- inner_join(DOres[,c("wbic_year","n","P","B","PB")],
                      DGres[,c("wbic_year","P","B","PB")],
                      by="wbic_year",suffix=c(".DO",".DG")) %>%
  mutate(diffB=B.DG-B.DO,pdiffB=diffB/B.DO*100,diffBgt50=pdiffB>50,
         diffP=P.DG-P.DO,pdiffP=diffP/P.DO*100,diffPgt50=pdiffP>50,
         diffPB=PB.DG-PB.DO,pdiffPB=diffPB/PB.DO*100,diffPBgt50=pdiffPB>50)
WYs_DODG <- unique(DODGres$wbic_year)
```


### WBIC_YEAR
```{r wbicAnalysis, echo=FALSE, cache=TRUE}
# WBIC_YEARs in Daisuke's but not our results
DG_notin_DO <- WYs_DG[which(!(WYs_DG %in% WYs_DODG))]

# Of Daisuke's WBIC_YEARs that we don't have, which don't have a PE for us
PE <- read.csv("../data/prepped/PE.csv",stringsAsFactors=FALSE)
WYs_PE <- unique(PE$wbic_year)
DG_notin_PE <- DG_notin_DO[which(!(DG_notin_DO %in% WYs_PE))]

# Of Daisuke's WBIC_YEARs that we don't have, which are not in the original FMDB file
FMDBo <- read.csv("../data/original/raw_data_walleye_20170803.csv",stringsAsFactors=FALSE) %>%
  mutate(wbic_year=paste(WBIC,SURVEY_YEAR,sep="_"))
WYs_FMDBo <- unique(FMDBo$wbic_year)
DG_notin_FMDBo <- DG_notin_DO[which(!(DG_notin_DO %in% WYs_FMDBo))]

# Of Daisuke's WBIC_YEARs that we don't have, which are not in the prepped FMDB file
FMDB <- read.csv("../data/prepped/fmdb_wae.csv",stringsAsFactors=FALSE)
WYs_FMDB <- unique(FMDB$wbic_year)
DG_notin_FMDB <- DG_notin_DO[which(!(DG_notin_DO %in% WYs_FMDB))]
```

Daisuke's results used `r length(WYs_DG)` WBIC_YEARs. Our results, which included years after Daisuke's, had `r length(WYs_DO1)` WBIC_YEARs, but this was reduced to `r length(WYs_DO)` WBIC_YEARs when "invalid" estimates were excluded. Our results shared `r length(WYs_DODG)` WBIC_YEARs with Daisuke's results. Of the `r length(DG_notin_DO)` WBIC_YEARs in Daisuke's results that were not in our results, `r length(DG_notin_PE)` were not in our file of PEs, `r length(DG_notin_FMDBo)` were not in our original file of raw data from the FMDB, and `r length(DG_notin_FMDB)` were not in our prepped file of raw data from the FMDB. Thus, from our results, `r length(DG_notin_PE)` WBIC_YEARs were excluded because we did not have a PE and `r length(DG_notin_FMDB)` WBIC_YEARs were excluded because of choices we made when prepping the raw FMDB file (a review of the data prepper log suggests that all of these WBIC_YEARs were lost when we restricted the analysis to fish captured with fyke nets in the spring). The WBIC_YEARs in Daisuke's analysis that are not in our analysis are below.
```{r echo=FALSE}
# this splitting and the data.frame allows for sorting, which makes it
# easier to find these issues in the data files.
tmp <- do.call(rbind,strsplit(DG_notin_PE,"_"))
tmp <- data.frame(wbic_year=DG_notin_PE,wbic=as.numeric(tmp[,1]),
                  year=as.numeric(tmp[,2]),stringsAsFactors=FALSE) %>%
  arrange(wbic,year)
cat("WBIC_YEARs in Daisuke's results for which we do not have a PE.\n")
tmp$wbic_year
tmp <- do.call(rbind,strsplit(DG_notin_FMDB,"_"))
tmp <- data.frame(wbic_year=DG_notin_FMDB,wbic=as.numeric(tmp[,1]),
                  year=as.numeric(tmp[,2]),stringsAsFactors=FALSE) %>%
  arrange(wbic,year)
cat("WBIC_YEARs in Daisuke's results that were excluded in our prepping the FMDB file.\n")
tmp$wbic_year
```



## Computation Results

```{r echo=FALSE, results="hide", out.width='0.33\\textwidth'}
par(mar=c(3,3,0.5,0.5),mgp=c(2.1,0.35,0),tcl=-0.2,las=1)
figs("BComp","Daisuke's B (LEFT) and the percentage difference in B (MIDDLE and RIGHT) versus our B. Values that are more than 100% different are marked on the middle plot.")
maxB <- with(DODGres,max(c(B.DG,B.DO)))+2
plot(B.DG~B.DO,data=DODGres,pch=19,col=col2rgbt("black",1/5),
     ylab="Daisuke's B",xlab="Our B",xlim=c(0,maxB),ylim=c(0,maxB))
grid()
abline(a=0,b=1,lty=2,col="red")
plot(pdiffB~B.DO,data=DODGres,pch=19,col=col2rgbt("black",1/5),
     ylab="Percent Difference in B",xlab="Our B")
grid()
abline(h=0,lty=2,col="red")
abline(h=c(-50,50),lty=3,col="red")
badB <- which(abs(DODGres$pdiffB)>100)
with(DODGres[badB,],text(B.DO,pdiffB,wbic_year,pos=4,cex=0.6))
plot(pdiffB~B.DO,data=DODGres,pch=19,col=col2rgbt("black",1/5),
     ylab="Percent Difference in B",xlab="Our B",ylim=c(-50,50))
grid()
abline(h=0,lty=2,col="red")
abline(h=c(-50,50),lty=3,col="red")
```

`r figs("BComp")`


```{r PComp,echo=FALSE, results="hide", out.width='0.33\\textwidth'}
par(mar=c(3,3,0.5,0.5),mgp=c(2.1,0.35,0),tcl=-0.2,las=1)
figs("PComp","Daisuke's P (LEFT) and the percentage difference in P (MIDDLE and RIGHT) versus our P. Values that are more than 200% different are marked on the middle plot.")
maxP <- with(DODGres,max(c(P.DG,P.DO)))+1
plot(P.DG~P.DO,data=DODGres,pch=19,col=col2rgbt("black",1/5),
     ylab="Daisuke's P",xlab="Our P",xlim=c(0,maxP),ylim=c(0,maxP))
grid()
abline(a=0,b=1,lty=2,col="red")
plot(pdiffP~P.DO,data=DODGres,pch=19,col=col2rgbt("black",1/5),
     ylab="Percent Difference in P",xlab="Our P")
grid()
abline(h=0,lty=2,col="red")
abline(h=c(-50,50),lty=3,col="red")
badP <- which(abs(DODGres$pdiffP)>200)
with(DODGres[badP,],text(P.DO,pdiffP,wbic_year,pos=4,cex=0.6))
plot(pdiffP~P.DO,data=DODGres,pch=19,col=col2rgbt("black",1/5),
     ylab="Percent Difference in P",xlab="Our P",ylim=c(-100,200))
grid()
abline(h=0,lty=2,col="red")
abline(h=c(-50,50),lty=3,col="red")
```

`r figs("PComp")`

```{r PBComp, echo=FALSE, results="hide", out.width='0.33\\textwidth'}
par(mar=c(3,3,0.5,0.5),mgp=c(2.1,0.35,0),tcl=-0.2,las=1)
figs("PBComp","Daisuke's P (LEFT) and the percentage difference in P/B (MIDDLE and RIGHT) versus our P/B. Values that are more than 200% different are marked on the middle plot.")
maxPB <- with(DODGres,max(c(PB.DG,PB.DO)))+0.05
plot(PB.DG~PB.DO,data=DODGres,pch=19,col=col2rgbt("black",1/5),
     ylab="Daisuke's P/B",xlab="Our P/B",xlim=c(0,maxPB),ylim=c(0,maxPB))
grid()
abline(a=0,b=1,lty=2,col="red")
plot(pdiffPB~PB.DO,data=DODGres,pch=19,col=col2rgbt("black",1/5),
     ylab="Percent Difference in P/B",xlab="Our P/B")
grid()
abline(h=0,lty=2,col="red")
abline(h=c(-50,50),lty=3,col="red")
badPB <- which(abs(DODGres$pdiffPB)>200)
with(DODGres[badPB,],text(PB.DO,pdiffPB,wbic_year,pos=4,cex=0.6))
plot(pdiffPB~PB.DO,data=DODGres,pch=19,col=col2rgbt("black",1/5),
     ylab="Percent Difference in P/B",xlab="Our P/B",ylim=c(-100,200))
grid()
abline(h=0,lty=2,col="red")
abline(h=c(-50,50),lty=3,col="red")
```

`r figs("PBComp")`

```{r echo=FALSE, eval=FALSE}
## This will print the results tables for WBIC_YEARs considered to be "bad"
## Need to remove eval=FALSE in chunk option
cat("\nResults tables for WBIC_YEARs with a large difference in B values.")
for (i in badB) {
  cat("\n",DODGres[i,]$wbic_year,"\n")
  tmp <- read.csv(paste0("../results/calcPB_Tables/PB_SM_IW_",DODGres[i,]$wbic_year,".csv"))
  print(round(tmp,3))
}

cat("\nCalculations tables for WBIC_YEARs with a large difference in P values.")
for (i in badP) {
  cat("\n",DODGres[i,]$wbic_year,"\n")
  if (i %in% badB) cat("Shown above.\n")
  else {
  tmp <- read.csv(paste0("../results/calcPB_Tables/PB_SM_IW_",DODGres[i,]$wbic_year,".csv"))
  print(round(tmp,3))    
  }
}

cat("\nCalculations tables for WBIC_YEARs with a large difference in P/B values.")
for (i in badPB) {
  cat("\n",DODGres[i,]$wbic_year,"\n")
  if (i %in% c(badB,badP)) cat("Shown above.\n")
  else {
  tmp <- read.csv(paste0("../results/calcPB_Tables/PB_SM_IW_",DODGres[i,]$wbic_year,".csv"))
  print(round(tmp,3))    
  }
}

cat("\nCalculations summaries for each WBIC_YEAR highlighted above.")
DOres[DOres$wbic_year %in% DODGres[c(badB,badP,badPB),]$wbic_year,]
```


## "Raw" Data Comparison
### PEs
```{r echo=FALSE, results="hide"}
# Get PEs and sizes by isolating them from WIwalleye_len_pe.csv
# Converted size from m^2 to HA, round to 1 decimal to match our results
# Note ... reduce this to only those WBIC_YEARs for which he computed P
#          which are in WYs_DG from above.
DGpeha <- read.csv("zzzOld_FromDaisuke/WIwalleye_len_pe.csv",stringsAsFactors=FALSE) %>%
  mutate(wbic_year=paste(wbic,year,sep="_"),
         HA=round(LakeArea/10000,1)) %>%
  rename(PE=pe) %>%
  select(wbic_year,wbic,year,PE,HA) %>%
  unique() %>%
  filterD(wbic_year %in% WYs_DG)
# Join our PEs from the results file to Daisuke's and compare
DODGpe <- inner_join(select(DOres,wbic_year,PE),select(DGpeha,wbic_year,PE),
                      by="wbic_year",suffix=c(".DO",".DG")) %>%
  mutate(diff=PE.DG-PE.DO,arediff=diff!=0)
any(DODGpe$arediff)
```

The PEs were the same for `r nrow(DODGpe)` WBIC_YEARs in common between our and Daisuke's analysis.

### Lake Size
```{r echo=FALSE, results="hide"}
# Join our sizes from the results file to Daisuke's and compare
DOsize <- unique(select(DOres,wbic,HA))
DGsize <- unique(select(DGpeha,wbic,HA))
DODGsize <- inner_join(DOsize,DGsize,by="wbic",suffix=c(".DO",".DG")) %>%
  mutate(diff=HA.DG-HA.DO,pdiff=diff/HA.DO*100,adjSize_DG2DO=HA.DG/HA.DO,
         nobigdiff=(adjSize_DG2DO>0.99 & adjSize_DG2DO<1.01))
sztab <- xtabs(~nobigdiff,data=DODGsize)
szsum <- Summarize(~pdiff,data=DODGsize)
```

Lake size was exactly the same for `r formatC(szsum["percZero"],format="f",digits=1)`% and within 1% of each other for `r formatC(sztab[["TRUE"]]/sum(sztab)*100,format="f",digits=1)`% of WBICs in common between our and Daisuke's analysis (`r figs("DiffHA",display="cite")`). For what it is worth, our lake sizes for the four large differences in `r figs("DiffHA",display="cite")` match what is available in the [online lake app](http://dnr.wi.gov/lakes/lakepages/Search.aspx?show=search).

```{r DiffHA, echo=FALSE, results="hide", out.width='.33\\textwidth'}
Summarize(~diff,data=DODGsize,digits=2)
par(mar=c(3,3,0.5,0.5),mgp=c(2.1,0.35,0),tcl=-0.2,las=1)
figs("DiffHA","Daisuke's lake size (LEFT) and the ratio between Daisuke's and our lake sizes (RIGHT) versus lake size in our analysis. WBICs for which the difference was more than 1% are marked.")
maxHA <- with(DODGsize,max(c(HA.DO,HA.DG)))
plot(HA.DG~HA.DO,data=DODGsize,pch=19,col=col2rgbt("black",1/5),
     ylab="Difference in Lake Size (ha)",xlab="Our Lake Size (ha)",
     xlim=c(0,maxHA),ylim=c(0,maxHA))
grid()
abline(a=0,b=1,lty=2,col="red")
plot(adjSize_DG2DO~HA.DO,data=DODGsize,pch=19,col=col2rgbt("black",1/5),
     ylab="Ratio of Daisuke's to Our Lake Size",xlab="Our Lake Size (ha)")
grid()
abline(h=1,lty=2,col="red")
with(filterD(DODGsize,adjSize_DG2DO<0.985),text(HA.DO,adjSize_DG2DO,
                                                wbic,pos=c(1,2,3,3),
                                                cex=0.8))
```

`r figs("DiffHA")`


## Weight-Length Relationships
```{r echo=FALSE, results="hide", warning=FALSE}
lwDG <- read.csv("zzzOld_FromDaisuke/WIwalleye_len-mass.csv",stringsAsFactors=FALSE) %>%
  mutate(logw=log(mass),logl=log(length))
lw_wy_DG <- nlme::lmList(logw~logl|wbic_year,data=lwDG,na.action=na.pass)
wy_DG_res <- LWINFO(lw_wy_DG,"WBIC_YEAR") %>%
  select(loga,b,n,rsq,which)

wy_DO_res <- read.csv("../data/prepped/LWregs.csv",stringsAsFactors=FALSE) %>%
  filterD(type=="WBIC_YEAR") %>%
  select(loga,b,n,rsq,which)

wy_DODG <- left_join(wy_DO_res,wy_DG_res,by="which",suffix=c(".DO",".DG")) %>%
  mutate(loga.diff=loga.DG-loga.DO,b.diff=b.DG-b.DO,
         n.diff=n.DG-n.DO,rsq.diff=rsq.DG-rsq.DO,
         loga.nobigdiff=((loga.DG/loga.DO)>0.99 & (loga.DG/loga.DO)<1.01),
         b.nobigdiff=((b.DG/b.DO)>0.99 & (b.DG/b.DO)<1.01),
         n.nobigdiff=((n.DG/n.DO)>0.99 & (n.DG/n.DO)<1.01),
         rsq.nobigdiff=((rsq.DG/rsq.DO)>0.99 & (rsq.DG/rsq.DO)<1.01))
loga.tab <- xtabs(~loga.nobigdiff,data=wy_DODG)
loga.sum <- Summarize(~loga.diff,data=wy_DODG)
b.tab <- xtabs(~b.nobigdiff,data=wy_DODG)
b.sum <- Summarize(~b.diff,data=wy_DODG)
n.tab <- xtabs(~n.nobigdiff,data=wy_DODG)
n.sum <- Summarize(~n.diff,data=wy_DODG)
rsq.tab <- xtabs(~rsq.nobigdiff,data=wy_DODG)
rsq.sum <- Summarize(~rsq.diff,data=wy_DODG)
```

Of the `r nrow(wy_DODG)` weight-length relationships shared between our and Daisuke's analyses (restricted to only WBIC_YEAR regressions), `r formatC(loga.tab[["TRUE"]]/sum(loga.tab)*100,format="f",digits=1)`% were within 1% of each other for $log(a)$, `r formatC(b.tab[["TRUE"]]/sum(b.tab)*100,format="f",digits=1)`% were within 1% of each other for $b$, `r formatC(n.tab[["TRUE"]]/sum(n.tab)*100,format="f",digits=1)`% were within 1% of each other for $n$, and `r formatC(rsq.tab[["TRUE"]]/sum(rsq.tab)*100,format="f",digits=1)`% were within 1% of each other for $r^{2}$ (`r figs("DiffWL",display="cite")`). Note that one of the most different regression results were from 2013, which was not used in Daisuke's analysis.

```{r DiffWL, echo=FALSE, results="hide", out.width='.33\\textwidth'}
par(mar=c(3,3,0.5,0.5),mgp=c(2.1,0.35,0),tcl=-0.2,las=1)
figs("DiffWL","Differenes in Daisuke's and our weight-length regression results versus our weight-length regression results for four summary statistics.")
plot(loga.diff~loga.DO,data=wy_DODG,pch=19,col=col2rgbt("black",1/5),
     ylab="Difference in log(a)",xlab="Our log(a)")
abline(h=0,lty=2,col="red")
with(filterD(wy_DODG,abs(loga.diff)>0.05),text(loga.DO,loga.diff,which,pos=2,cex=0.8))
plot(b.diff~b.DO,data=wy_DODG,pch=19,col=col2rgbt("black",1/5),
     ylab="Difference in b",xlab="Our b")
abline(h=0,lty=2,col="red")
with(filterD(wy_DODG,abs(b.diff)> 0.01),text(b.DO,b.diff,which,pos=2,cex=0.8))
plot(n.diff~n.DO,data=wy_DODG,pch=19,col=col2rgbt("black",1/5),
     ylab="Difference in n",xlab="Our n")
abline(h=0,lty=2,col="red")
with(filterD(wy_DODG,abs(n.diff)>50),text(n.DO,n.diff,which,pos=4,cex=0.8))
plot(rsq.diff~rsq.DO,data=wy_DODG,pch=19,col=col2rgbt("black",1/5),
     ylab="Difference in r^2",xlab="Our r^2")
abline(h=0,lty=2,col="red")
with(filterD(wy_DODG,rsq.diff< -0.002),text(rsq.DO,rsq.diff,which,pos=2,cex=0.8))
```

`r figs("DiffWL")`