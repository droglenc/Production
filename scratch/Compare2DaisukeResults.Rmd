---
title: "Compare to Daisuke's Results"
author: "Derek H. Ogle"
date: "August 8, 2017"
output: 
  pdf_document: 
    fig_height: 3.5
    fig_width: 3.5
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
knitr::opts_chunk$set(echo=TRUE,comment="")
library(FSA)
library(dplyr)
library(magrittr)
library(readxl)
library(plotrix)
library(xtable)
library(captioner)
figs <- captioner("Figure")
tabs <- captioner("Table")
source("../code/helpers/productionHelpers.R")
```


```{r loadData, echo=FALSE, cache=TRUE}
## !!NOTE!! Set working directory to source file to analyze "on-the-fly"
#setwd("C:/aaaWork/Research/Production/scratch")

# Daisuke's Files
## His overall P/B results
DGres <- read_excel("zzzOld_FromDaisuke/Daisuke Production Estimates.xlsx") %>%
  rename(wbic=WBIC,year=Year,wbic_year=WBIC_Year,P="P (kg/ha/y)",B="B (kg/ha)") %>%
  mutate(PB=P/B) %<>%
  select(wbic_year,wbic,year,P,B,PB)
## His PE and lake sizes
### Get PEs and sizes by isolating them from WIwalleye_len_pe.csv
### Converted size from m^2 to HA, round to 1 decimal to match our results
DGPEHA <- read.csv("zzzOld_FromDaisuke/WIwalleye_len_pe.csv",
                   stringsAsFactors=FALSE) %>%
  mutate(wbic_year=paste(wbic,year,sep="_"),
         HA=round(LakeArea/10000,1)) %>%
  rename(PE=pe) %>%
  select(wbic_year,wbic,year,PE,HA) %>%
  unique()
## His length-weight data
DGLW <- read.csv("zzzOld_FromDaisuke/WIwalleye_len-mass.csv",
                 stringsAsFactors=FALSE) %>%
  mutate(logw=log(mass),logl=log(length))
## His length-age data
DGLA <- read.csv("zzzOld_FromDaisuke/WIwalleye_age_len.csv",
                 stringsAsFactors=FALSE) %>%
  rename(len.mm=length) %>%
  select(wbic_year,wbic,year,len.mm,age) %>%
  filterD(!is.na(len.mm),!is.na(age))
## His lengths (used to expand for ages and weights)
DGLENS <- read.csv("zzzOld_FromDaisuke/WIwalleye_len_pe.csv",
                    stringsAsFactors=FALSE) %>%
  mutate(wbic_year=paste(wbic,year,sep="_")) %>%
  rename(len.mm=length) %>%
  select(wbic_year,len.mm)

# Our Files
## Our overall P/B results ... before deleting invalid estimates
DOres1 <- read.csv("../results/PB_SM_IW.csv",stringsAsFactors=FALSE) %>%
  mutate(PB=P/B)
## Our overall P/B results ... after deleting invalid estimates
DOres <- filterD(DOres1,use=="yes")
## Our PEs
DOPE <- read.csv("../data/prepped/PE.csv",stringsAsFactors=FALSE)
## Our original FMDB file
DOFMDBo <- read.csv("../data/original/raw_data_walleye_20170803.csv",
                    stringsAsFactors=FALSE,na.strings=c("-","NA","")) %>%
  mutate(wbic_year=paste(WBIC,SURVEY_YEAR,sep="_"))
## Our prepped FMDB file
DOFMDBp <- read.csv("../data/prepped/fmdb_wae.csv",
                    stringsAsFactors=FALSE)
## Our length-weight results
DOLWres <- read.csv("../data/prepped/LWregs.csv",stringsAsFactors=FALSE) %>%
  filterD(type=="WBIC_YEAR") %>%
  select(loga,b,n,rsq,which)
## Our original age-length data
DOLAo <- read.csv("../data/original/length_weight_age_raw_data_8_1_17.csv",
                  stringsAsFactors=FALSE,na.strings=c("-","NA","")) %>%
  rename(wbic=WBIC,year=Survey.Year,len.mm=Length.MM,len.in=Length.IN,
         age=Age..observed.annuli.) %>%
  mutate(wbic_year=paste(wbic,year,sep="_"),
         len.mm=len.in*25.4,
         age=as.numeric(age))%>%
  select(wbic_year,wbic,year,len.mm,age) %>%
  filterD(!is.na(len.mm),!is.na(age))


```



## Initial Comparison (to Daisuke's Compiled Results)
```{r compWYs, echo=FALSE, results="hide"}
# WBIC_YEARs in Daisuke's overall results
WYs_DG <- unique(DGres$wbic_year)
# WBIC_YEARs in our results prioring to deleting invalid estimates
WYs_DO1 <- unique(DOres1$wbic_year)
# WBIC_YEARs that we considered to be invalid
invalidWYs_DO <- unique(filterD(DOres1,use=="NO")$wbic_year)
# WBIC_YEARs in our results after deleting invalid estimates
WYs_DO <- unique(DOres$wbic_year)

# Combined Daisuke's and our overall results
## Find differences, percentage differences for B, P, and PB
DODGres <- inner_join(DOres[,c("wbic_year","n","P","B","PB")],
                      DGres[,c("wbic_year","P","B","PB")],
                      by="wbic_year",suffix=c(".DO",".DG")) %>%
  mutate(diffB=B.DG-B.DO,pdiffB=diffB/B.DO*100,
         diffP=P.DG-P.DO,pdiffP=diffP/P.DO*100,
         diffPB=PB.DG-PB.DO,pdiffPB=diffPB/PB.DO*100)
# WBIC_YEARs that both results had in common
WYs_DODG <- unique(DODGres$wbic_year)

# WBIC_YEARs in Daisuke's but not our final results
DG_notin_DO <- WYs_DG[!(WYs_DG %in% WYs_DO)]
## This simply orders them by WBIC and then year ... easier to look at
tmp <- do.call(rbind,strsplit(DG_notin_DO,"_"))
DG_notin_DO <- data.frame(wbic_year=DG_notin_DO,wbic=as.numeric(tmp[,1]),
                          year=as.numeric(tmp[,2]),stringsAsFactors=FALSE) %>%
  arrange(wbic,year) %>% select(wbic_year)
DG_notin_DO <- DG_notin_DO$wbic_year

# Of Daisuke's WBIC_YEARs that we don't have, which don't have a PE for us
WYs_DOPE <- unique(DOPE$wbic_year)
DG_notin_DOPE <- DG_notin_DO[!(DG_notin_DO %in% WYs_DOPE)]
# Of Daisuke's WBIC_YEARs that we don't have, which are not in the original FMDB file
WYs_DOFMDBo <- unique(DOFMDBo$wbic_year)
DG_notin_DOFMDBo <- DG_notin_DO[!(DG_notin_DO %in% WYs_DOFMDBo)]
# Of Daisuke's WBIC_YEARs that we don't have, which are not in the prepped FMDB file
WYs_DOFMDBp <- unique(DOFMDBp$wbic_year)
DG_notin_DOFMDBp <- DG_notin_DO[!(DG_notin_DO %in% WYs_DOFMDBp)]
## Some of these were removed because no PE ... remove those from the list
DG_notin_DOFMDBp <- DG_notin_DOFMDBp[!(DG_notin_DOFMDBp %in% DG_notin_DOPE)]
# Of Daisuke's WBIC_YEARs that we don't have, how many did we consider to be invalid
DG_in_invalid <- DG_notin_DO[DG_notin_DO %in% invalidWYs_DO]

# Reasons that we considered the results to be invalid
## rearranged to match sequential decision ladder
invtab <- xtabs(~reason,data=DOres1[DOres1$wbic_year %in% DG_in_invalid,])
invtab <- invtab[c("n<30","numAges<5","Age gaps issue")]
tabs("InvTab","Frequency of WBIC_YEARs in Daisuke's analysis that were excluded from our results by the reason we considered the results to be invalid.")
```

Daisuke's results used `r length(WYs_DG)` WBIC_YEARs. Our results, which included years after Daisuke's, had `r length(WYs_DO1)` WBIC_YEARs, but this was reduced to `r length(WYs_DO)` WBIC_YEARs when "invalid" estimates were excluded. Our results shared `r length(WYs_DODG)` WBIC_YEARs with Daisuke's results. Of the `r length(DG_notin_DO)` WBIC_YEARs in Daisuke's results that were not in our results, `r length(DG_notin_DOPE)` were not in our file of PEs, `r length(DG_notin_DOFMDBo)` were not in our original file of raw data from the FMDB, `r length(DG_notin_DOFMDBp)` were not in our prepped file of raw data from the FMDB, and `r length(DG_in_invalid)` were excluded because we considered the results to be invalid. A review of the data prepper log suggests that all of the WBIC_YEARs removed during data prepping occurred when the data were restricted to fish captured with fyke nets in the spring. `r tabs("InvTab",display="cite")` shows the reasons why we excluded the `r sum(invtab)` WBIC_YEARs in Daisuke's results that were not in our results. 

`r tabs("InvTab")`

```{r InvTab, echo=FALSE, results='asis'}
print(xtable(data.frame(invtab)),include.rownames=FALSE,comment=FALSE)
```

WBIC_YEARs in Daisuke's results that were not in our results are listed below.
```{r echo=FALSE}
cat("WBIC_YEARs in Daisuke's results for which we do not have a PE.\n")
DG_notin_DOPE
cat("WBIC_YEARs in Daisuke's results that were excluded in our prepping the FMDB file.\n")
DG_notin_DOFMDBp
cat("WBIC_YEARs in Daisuke's results that we considered invalid.\n")
DG_in_invalid
```

\newpage

## Computation Results
Comparisons of our results to Daisuke's results for B, P, and P/B are in `r figs("BComp",display="cite")`, `r figs("PComp",display="cite")`, and `r figs("PBComp",display="cite")`, respectively. Correlations between our and Daisuke's estimates are not as strong as I would have expected given that they originated from the same data (however, see the next section).

```{r BComp, echo=FALSE, results="hide", out.width='0.33\\textwidth'}
par(mar=c(3,3,0.5,0.5),mgp=c(2.1,0.35,0),tcl=-0.2,las=1)
figs("BComp","Daisuke's B (LEFT) and the percentage difference in B (MIDDLE and RIGHT) versus our B. Values that are more than 100% different are marked on the middle plot.")
maxB <- with(DODGres,max(c(B.DG,B.DO)))+2
plot(B.DG~B.DO,data=DODGres,pch=19,col=col2rgbt("black",1/5),
     ylab="Daisuke's B",xlab="Our B",xlim=c(0,maxB),ylim=c(0,maxB))
grid()
abline(a=0,b=1,lty=2,col="red")
text(25,0,paste0("r=",formatC(with(DODGres,cor(B.DG,B.DO)),format="f",digits=3)))
plot(pdiffB~B.DO,data=DODGres,pch=19,col=col2rgbt("black",1/5),
     ylab="Percent Difference (DG-DO) in B",xlab="Our B")
grid()
abline(h=0,lty=2,col="red")
abline(h=c(-50,50),lty=3,col="red")
badB <- which(abs(DODGres$pdiffB)>100)
with(DODGres[badB,],text(B.DO,pdiffB,wbic_year,pos=4,cex=0.6))
plot(pdiffB~B.DO,data=DODGres,pch=19,col=col2rgbt("black",1/5),
     ylab="Percent Difference (DG-DO) in B",xlab="Our B",ylim=c(-50,50))
grid()
abline(h=0,lty=2,col="red")
abline(h=c(-50,50),lty=3,col="red")
```

`r figs("BComp")`


```{r PComp,echo=FALSE, results="hide", out.width='0.33\\textwidth'}
par(mar=c(3,3,0.5,0.5),mgp=c(2.1,0.35,0),tcl=-0.2,las=1)
figs("PComp","Daisuke's P (LEFT) and the percentage difference in P (MIDDLE and RIGHT) versus our P. Values that are more than 200% different are marked on the middle plot.")
maxP <- with(DODGres,max(c(P.DG,P.DO)))+1
plot(P.DG~P.DO,data=DODGres,pch=19,col=col2rgbt("black",1/5),
     ylab="Daisuke's P",xlab="Our P",xlim=c(0,maxP),ylim=c(0,maxP))
grid()
abline(a=0,b=1,lty=2,col="red")
text(6,0,paste0("r=",formatC(with(DODGres,cor(P.DG,P.DO)),format="f",digits=3)))
plot(pdiffP~P.DO,data=DODGres,pch=19,col=col2rgbt("black",1/5),
     ylab="Percent Difference (DG-DO) in P",xlab="Our P")
grid()
abline(h=0,lty=2,col="red")
abline(h=c(-50,50),lty=3,col="red")
badP <- which(abs(DODGres$pdiffP)>200)
with(DODGres[badP,],text(P.DO,pdiffP,wbic_year,pos=4,cex=0.6))
plot(pdiffP~P.DO,data=DODGres,pch=19,col=col2rgbt("black",1/5),
     ylab="Percent Difference (DG-DO) in P",xlab="Our P",ylim=c(-100,200))
grid()
abline(h=0,lty=2,col="red")
abline(h=c(-50,50),lty=3,col="red")
```

`r figs("PComp")`

```{r PBComp, echo=FALSE, results="hide", out.width='0.33\\textwidth'}
par(mar=c(3,3,0.5,0.5),mgp=c(2.1,0.35,0),tcl=-0.2,las=1)
figs("PBComp","Daisuke's P (LEFT) and the percentage difference in P/B (MIDDLE and RIGHT) versus our P/B. Values that are more than 200% different are marked on the middle plot.")
maxPB <- with(DODGres,max(c(PB.DG,PB.DO)))+0.05
plot(PB.DG~PB.DO,data=DODGres,pch=19,col=col2rgbt("black",1/5),
     ylab="Daisuke's P/B",xlab="Our P/B",xlim=c(0,maxPB),ylim=c(0,maxPB))
grid()
abline(a=0,b=1,lty=2,col="red")
text(0.35,0,paste0("r=",formatC(with(DODGres,cor(PB.DG,PB.DO)),format="f",digits=3)))
plot(pdiffPB~PB.DO,data=DODGres,pch=19,col=col2rgbt("black",1/5),
     ylab="Percent Difference (DG-DO) in P/B",xlab="Our P/B")
grid()
abline(h=0,lty=2,col="red")
abline(h=c(-50,50),lty=3,col="red")
badPB <- which(abs(DODGres$pdiffPB)>200)
with(DODGres[badPB,],text(PB.DO,pdiffPB,wbic_year,pos=4,cex=0.6))
plot(pdiffPB~PB.DO,data=DODGres,pch=19,col=col2rgbt("black",1/5),
     ylab="Percent Difference (DG-DO) in P/B",xlab="Our P/B",ylim=c(-100,200))
grid()
abline(h=0,lty=2,col="red")
abline(h=c(-50,50),lty=3,col="red")
```

`r figs("PBComp")`

```{r echo=FALSE}
cat("WBIC_YEARs for which our and Daisuke's B estimates were very different:")
DODGres[badB,c("wbic_year","B.DO","B.DG","pdiffB")]
cat("\nWBIC_YEARs for which our and Daisuke's P estimates were very different:")
DODGres[badP,c("wbic_year","P.DO","P.DG","pdiffP")]
cat("\nWBIC_YEARs for which our and Daisuke's P/B estimates were very different:")
DODGres[badPB,c("wbic_year","PB.DO","PB.DG","pdiffPB")]
WYs_PBIssues <- unique(DODGres$wbic_year[c(badB,badP,badPB)])
```



```{r echo=FALSE, eval=FALSE}
## This will print the results tables for WBIC_YEARs considered to be "bad"
## Need to remove eval=FALSE in chunk option
cat("\nResults tables for WBIC_YEARs with a large difference in B values.")
for (i in badB) {
  cat("\n",DODGres[i,]$wbic_year,"\n")
  tmp <- read.csv(paste0("../results/calcPB_Tables/PB_SM_IW_",DODGres[i,]$wbic_year,".csv"))
  print(round(tmp,3))
}

cat("\nCalculations tables for WBIC_YEARs with a large difference in P values.")
for (i in badP) {
  cat("\n",DODGres[i,]$wbic_year,"\n")
  if (i %in% badB) cat("Shown above.\n")
  else {
  tmp <- read.csv(paste0("../results/calcPB_Tables/PB_SM_IW_",DODGres[i,]$wbic_year,".csv"))
  print(round(tmp,3))    
  }
}

cat("\nCalculations tables for WBIC_YEARs with a large difference in P/B values.")
for (i in badPB) {
  cat("\n",DODGres[i,]$wbic_year,"\n")
  if (i %in% c(badB,badP)) cat("Shown above.\n")
  else {
  tmp <- read.csv(paste0("../results/calcPB_Tables/PB_SM_IW_",DODGres[i,]$wbic_year,".csv"))
  print(round(tmp,3))    
  }
}

cat("\nCalculations summaries for each WBIC_YEAR highlighted above.")
DOres[DOres$wbic_year %in% DODGres[c(badB,badP,badPB),]$wbic_year,]
```


## "Raw" Data Comparison
### PEs
```{r echo=FALSE, results="hide"}
# Get PEs from DGPEHA ... reduce this to only those WBIC_YEARs for which
# he computed P (which are in WYs_DG from above.)
DGPE <- select(DGPEHA,wbic_year,PE) %>%
  filterD(wbic_year %in% WYs_DG)
# Join our PEs from the results file to Daisuke's and compare
DODGpe <- inner_join(select(DOres,wbic_year,PE),DGPE,
                      by="wbic_year",suffix=c(".DO",".DG")) %>%
  mutate(diff=PE.DG-PE.DO,arediff=diff!=0)
any(DODGpe$arediff)
```

The PEs were the same for `r nrow(DODGpe)` WBIC_YEARs in common between our and Daisuke's analysis. **Thus, it does not appear that differences in PEs would explain the differences between our's and Daisuke's estimates of P and B.**

### Lake Size
```{r echo=FALSE, results="hide"}
# Get lake sizes from DGPEHA ... reduce this to only those WBIC_YEARs
# for which he computed P (which are in WYs_DG from above.) Must send to
# unique() to remove duplicates within any given WBIC (i.e., mult years).
DGHA <- filterD(DGPEHA,wbic_year %in% WYs_DG) %>%
  select(wbic,HA) %>%
  unique()
# Get our sizes
DOHA <- select(DOres,wbic,HA) %>%
  unique()
# Join our sizes from the results file to Daisuke's and compare
DODGsize <- inner_join(DOHA,DGHA,by="wbic",suffix=c(".DO",".DG")) %>%
  mutate(diff=HA.DG-HA.DO,pdiff=diff/HA.DO*100,ratio=HA.DG/HA.DO,
         nobigdiff=(ratio>0.99 & ratio<1.01))
sztab <- xtabs(~nobigdiff,data=DODGsize)
szsum <- Summarize(~pdiff,data=DODGsize)
```

Lake size was exactly the same for `r formatC(szsum[["percZero"]],format="f",digits=1)`% and within 1% of each other for `r formatC(sztab[["TRUE"]]/sum(sztab)*100,format="f",digits=1)`% of the `r sum(sztab)` WBICs in common between our and Daisuke's results (`r figs("DiffHA",display="cite")`). Our lake sizes for the four large differences in `r figs("DiffHA",display="cite")` match what is available in the [online lake app](http://dnr.wi.gov/lakes/lakepages/Search.aspx?show=search). None of the four lage differences in lake sizes matched with any of the problematic P, B, or P/B estimates identified above. **Thus, it does not appear that these differences in lake size data will explain (to any great extent) the differences between our and Daisuke's estimates of P and B.**

```{r DiffHA, echo=FALSE, results="hide", out.width='.33\\textwidth'}
par(mar=c(3,3,0.5,0.5),mgp=c(2.1,0.35,0),tcl=-0.2,las=1)
figs("DiffHA","Daisuke's lake size (LEFT) and the ratio between Daisuke's and our lake sizes (RIGHT) versus lake size in our analysis. WBICs for which the difference was more than 1% are marked.")
maxHA <- with(DODGsize,max(c(HA.DO,HA.DG)))
plot(HA.DG~HA.DO,data=DODGsize,pch=19,col=col2rgbt("black",1/5),
     ylab="Daisuke's Lake Size (ha)",xlab="Our Lake Size (ha)",
     xlim=c(0,maxHA),ylim=c(0,maxHA))
grid()
abline(a=0,b=1,lty=2,col="red")
plot(ratio~HA.DO,data=DODGsize,pch=19,col=col2rgbt("black",1/5),
     ylab="Daisuke's / Our Lake Size",xlab="Our Lake Size (ha)")
grid()
abline(h=1,lty=2,col="red")
with(filterD(DODGsize,ratio<0.985),text(HA.DO,ratio,wbic,pos=c(1,2,3,3),cex=0.8))
```

`r figs("DiffHA")`


## Weight-Length Relationships
```{r echo=FALSE, results="hide", warning=FALSE}
tmp <- nlme::lmList(logw~logl|wbic_year,data=DGLW,na.action=na.pass)
DGLWres <- LWINFO(tmp,"WBIC_YEAR") %>% select(loga,b,n,rsq,which)

DODGLW <- inner_join(DOLWres,DGLWres,by="which",suffix=c(".DO",".DG")) %>%
  mutate(loga.diff=loga.DG-loga.DO,b.diff=b.DG-b.DO,
         n.diff=n.DG-n.DO,rsq.diff=rsq.DG-rsq.DO,
         loga.nobigdiff=((loga.DG/loga.DO)>0.99 & (loga.DG/loga.DO)<1.01),
         b.nobigdiff=((b.DG/b.DO)>0.99 & (b.DG/b.DO)<1.01),
         n.nobigdiff=((n.DG/n.DO)>0.99 & (n.DG/n.DO)<1.01),
         rsq.nobigdiff=((rsq.DG/rsq.DO)>0.99 & (rsq.DG/rsq.DO)<1.01))
loga.tab <- xtabs(~loga.nobigdiff,data=DODGLW)
loga.sum <- Summarize(~loga.diff,data=DODGLW)
b.tab <- xtabs(~b.nobigdiff,data=DODGLW)
b.sum <- Summarize(~b.diff,data=DODGLW)
n.tab <- xtabs(~n.nobigdiff,data=DODGLW)
n.sum <- Summarize(~n.diff,data=DODGLW)
rsq.tab <- xtabs(~rsq.nobigdiff,data=DODGLW)
rsq.sum <- Summarize(~rsq.diff,data=DODGLW)
```

We do not have access to Daisuke's weight-length relationship results. However, we computed the weight-length relationship for `r nrow(DODGLW)` WBIC_YEARs available (and matched what we had available) in what appears to be his weight-length data (were restricted to only WBIC_YEAR regressions that we considered valid). Of these, `r formatC(loga.tab[["TRUE"]]/sum(loga.tab)*100,format="f",digits=1)`% were within 1% of each other for $log(a)$, `r formatC(b.tab[["TRUE"]]/sum(b.tab)*100,format="f",digits=1)`% were within 1% of each other for $b$, `r formatC(n.tab[["TRUE"]]/sum(n.tab)*100,format="f",digits=1)`% were within 1% of each other for $n$, and `r formatC(rsq.tab[["TRUE"]]/sum(rsq.tab)*100,format="f",digits=1)`% were within 1% of each other for $r^{2}$ (`r figs("DiffWL",display="cite")`). Note that one of the most different regression results was from 2013, which was not used in Daisuke's analysis. None of the most different regression results matched with any of the problematic P, B, or P/B estimates identified above. **Thus, it does not appear that the actual weight-length relationships explain the difference between our and Daisuke's P and B estimates** (this assumes that Daisuke's weight-length relationships are the same as what we calculated here). However, **we could have used the weight-length relationships differently than he did.** For example, we may have used a different decision ladder to decide to use a weight-length regression other than the one for the specific WBIC_YEAR than Daisuke did (and we had regressions by lake class rather than region as Daisuke did). Or, Daisuke may have used the weight-length relationship to compute mean weight from mean length, rather than predicting weight for individual fish and then computing mean weight-at-age as we did.

```{r DiffWL, echo=FALSE, results="hide", fig.width=6, fig.height=6, out.width='.7\\textwidth'}
par(mar=c(3,3,0.5,0.5),mgp=c(2.1,0.35,0),tcl=-0.2,las=1,mfrow=c(2,2))
figs("DiffWL","Differenes in Daisuke's and our weight-length regression results versus our weight-length regression results for four summary statistics.")
plot(loga.diff~loga.DO,data=DODGLW,pch=19,col=col2rgbt("black",1/5),
     ylab="Daisuke's - Our log(a)",xlab="Our log(a)")
abline(h=0,lty=2,col="red")
with(filterD(DODGLW,abs(loga.diff)>0.05),text(loga.DO,loga.diff,which,pos=2,cex=0.8))
plot(b.diff~b.DO,data=DODGLW,pch=19,col=col2rgbt("black",1/5),
     ylab="Daisuke's - Our b",xlab="Our b")
abline(h=0,lty=2,col="red")
with(filterD(DODGLW,abs(b.diff)> 0.01),text(b.DO,b.diff,which,pos=2,cex=0.8))
plot(n.diff~n.DO,data=DODGLW,pch=19,col=col2rgbt("black",1/5),
     ylab="Daisuke's - Our n",xlab="Our n")
abline(h=0,lty=2,col="red")
with(filterD(DODGLW,abs(n.diff)>50),text(n.DO,n.diff,which,pos=4,cex=0.8))
plot(rsq.diff~rsq.DO,data=DODGLW,pch=19,col=col2rgbt("black",1/5),
     ylab="Daisuke's - Our r^2",xlab="Our r^2")
abline(h=0,lty=2,col="red")
with(filterD(DODGLW,rsq.diff< -0.002),text(rsq.DO,rsq.diff,which,pos=2,cex=0.8))
```

`r figs("DiffWL")`

\newpage

## Age-Length Data

```{r echo=FALSE, results="hide"}
sum_DOLAo <- group_by(DOLAo,wbic_year) %>%
  summarize(n=n(),mnlen=mean(len.mm),mnage=mean(age))
sum_DGLA <- group_by(DGLA,wbic_year) %>%
  summarize(n=n(),mnlen=mean(len.mm),mnage=mean(age))

# Joined for which summaries are in both files
# Reduced to only WBIC_YEARs that we calcd P&B for
sum_DODGLA <- inner_join(sum_DOLAo,sum_DGLA,by="wbic_year",
                         suffix=c(".DO",".DG")) %>%
  filterD(wbic_year %in% WYs_DO) %>%
  mutate(mnlen.diff=mnlen.DG-mnlen.DO,
         mnage.diff=mnage.DG-mnage.DO,
         n.diff=n.DG-n.DO,n.ratio=n.DG/n.DO) %>%
  as.data.frame()
Summarize(~mnlen.diff,data=sum_DODGLA,digits=2)
Summarize(~mnage.diff,data=sum_DODGLA,digits=2)
Summarize(~n.diff,data=sum_DODGLA,digits=2)
```

We did not have access to the specific age-length keys that Daisuke used. However, we could compute the sample size, mean length, and mean age for fish in the  `r nrow(sum_DODGLA)` WBIC_YEARs available (and matched what we had available) in what appears to be his length-age data. The most striking issue here is related to a series of WBIC_YEARs where our sample size was exactly or very nearly exactly twice as large as Daisuke's sample size. The WBIC_YEARs corresponding to these sample size issues do not seem to correspond to any great extent to mean lengths or mean ages that are very different between our and Daisuke's results. With this observation and an examination of our original data it appears that some of the records for these WBIC_YEARs are duplicated in our original data file. Andrew thinks that this is related to a past database migration issue and is investigating this further.

There appear to be a handful of other discrepancies in these data. However, I won't pursue these further until we address the possible duplication issue.

```{r DiffAge, echo=FALSE, results="hide", out.width='.33\\textwidth'}
par(mar=c(3,3,0.5,0.5),mgp=c(2.1,0.35,0),tcl=-0.2,las=1)
figs("DiffAge","Differenes in summaries of Daisuke's and our length-age data versus our summaries for three summary statistics.")
plot(mnlen.diff~mnlen.DO,data=sum_DODGLA,pch=19,col=col2rgbt("black",1/5),
     ylab="Difference (DG-DO) in Mean Length",xlab="Our Mean Length")
abline(h=0,lty=2,col="red")
#with(filterD(sum_DODGLA,abs(mnlen.diff)>10),text(mnlen.DO,mnlen.diff,wbic_year,pos=2,cex=0.8))
plot(mnage.diff~mnage.DO,data=sum_DODGLA,pch=19,col=col2rgbt("black",1/5),
     ylab="Difference (DG-DO) in Mean Age",xlab="Our Mean Age")
abline(h=0,lty=2,col="red")
#with(filterD(sum_DODGLA,abs(mnage.diff)> 0.3),text(mnage.DO,mnage.diff,wbic_year,pos=2,cex=0.8))
plot(n.diff~n.DO,data=sum_DODGLA,pch=19,col=col2rgbt("black",1/5),
     ylab="Difference (DG-DO) in n",xlab="Our n")
abline(h=0,lty=2,col="red")
#with(filterD(wy_DODG,abs(n.diff)>50),text(n.DO,n.diff,which,pos=4,cex=0.8))
```

`r figs("DiffAge")`

```{r echo=FALSE, results="hide"}
## Explore systematic differences in n
tmp <- which(sum_DODGLA$n.ratio==0.5)
sum_DODGLA[tmp,]

## for printing out the problems
crap <- sum_DODGLA[tmp,]
rownames(crap) <- crap$wbic_year
round(crap[,c("n.DO","n.DG","n.ratio","mnlen.diff","mnage.diff")],2)

tmp <- which(sum_DODGLA$n.ratio==2)
sum_DODGLA[tmp,]
```


\newpage

## Length Data in FMDB

There are MANY differences in the lengths data in our respective versions of "raw data from the FMDB" (this is AFTER our data had been prepped). Note that seven of the WBIC_YEARs had a difference in sample size of more than 5000 individuals! It is possible that I have misinterpreted which of Daisuke's files were his "lengths" (I used "WIwalleye_len_pe.csv").

It is possible that some of the WBIC_YEARs for which our data set are larger is due to data that have been entered into the FMDB since Daisuke's data run in 2012. That is some of the very large differences shown in the figures below have dates in the "FDV_ENT_DATE" field as post-2012. However, these WBIC_YEARs don't have any entries with dates before 2012 (so, not sure why they are in Daisuke's file).

**Assuming that I have chosen the correct file for Daisuke's lengths, this is likely the primary driver for the wide differences in our results.**

```{r echo=FALSE, results='hide'}
# Get our prepped lengths
DOLENS <- select(DOFMDBp,wbic_year,len.mm)

# To make Daisuke's lengths more comparable to what we did, delete fish
# < 7 in (minimum size for age-3) and fish >40 in
rows2delete <- which(DGLENS$len.mm<(7*25.4) | DGLENS$len.mm>(40*25.4))
DGLENS <- DGLENS[-rows2delete,]

sum_DOLENS <- group_by(DOLENS,wbic_year) %>%
  summarize(n=n(),mnlen=mean(len.mm))
sum_DGLENS <- group_by(DGLENS,wbic_year) %>%
  summarize(n=n(),mnlen=mean(len.mm))

sum_DODGLENS <- inner_join(sum_DOLENS,sum_DGLENS,by="wbic_year",
                           suffix=c(".DO",".DG")) %>%
  mutate(mnlen.diff=mnlen.DG-mnlen.DO,
         n.diff=n.DG-n.DO,n.ratio=n.DG/n.DO) %>%
  filterD(wbic_year %in% WYs_DO) %>%
  as.data.frame()
```

```{r DiffLens, echo=FALSE, results='hide', out.width='.33\\textwidth'}
par(mar=c(3,3,0.5,0.5),mgp=c(2.1,0.35,0),tcl=-0.2,las=1)
figs("DiffLens","Differences in summaries of Daisuke's and our length data versus our summaries for three summary statistics.")
plot(mnlen.diff~mnlen.DO,data=sum_DODGLENS,pch=19,col=col2rgbt("black",1/5),
     ylab="Difference (DG-DO) in Mean Length",xlab="Our Mean Length")
abline(h=0,lty=2,col="red")
#with(filterD(sum_DODGLENS,abs(mnlen.diff)>10),text(mnlen.DO,mnlen.diff,wbic_year,pos=2,cex=0.8))
plot(n.diff~n.DO,data=sum_DODGLENS,pch=19,col=col2rgbt("black",1/5),
     ylab="Difference (DG-DO) in n",xlab="Our n")
abline(h=0,lty=2,col="red")
with(filterD(sum_DODGLENS,abs(n.diff)>5000),text(n.DO,n.diff,wbic_year,pos=c(2,4,2,2,1,1,1),cex=0.8))
plot(n.ratio~n.DO,data=sum_DODGLENS,pch=19,col=col2rgbt("black",1/5),
     ylab="Ratio (DG/DO) of n [log scale]",xlab="Our n [log scale]",log="xy",yaxt="n")
axis(2,c(0.01,0.1,0.5,1,5))
abline(h=1,lty=2,col="red")
abline(h=0.5,lty=3,col="blue")
#with(filterD(wy_DODG,abs(n.diff)>50),text(n.DO,n.diff,which,pos=4,cex=0.8))
```

`r figs("DiffLens")`


Some examples (haphazardly picked and then filtered in Excel to compare to our results):

- "1001300_1999" has 93 records in our original raw FMDB file with a total of 130 fish (all data entry appeared to be in 2002 ... assumes that the "FDV_ENT_DATE" field is the date of data entry). When this is reduced to fyke nets in the spring there is a total of 70 fish. This matches our results (see below).
- "1018500_2012" has 370 records in our original raw FMDB file with a total of 1708 fish (all data entry appeared to be in April and October of 2012). When this is reduced to fyke nets in teh spring there is a total of 1227 fish. There were 11 fish under 7 in that we would have removed because the smallest 3-year-old was 7 in. These results match our results (see below).
- "1596300_1997" has 728 records in our original raw FMDB file with a total of 1320 fish (685 records for 1245 fish were entered in 2006, 43 records with 75 fish were added in 2014). When this is reduced to fyke nets in the spring there is a total of 801 fish. These results match our results (see below).
- "2295200_1992" has 791 records in our original raw FMDB file with a total of 4083 fish (all records appeared to be entered in 2014). When this is reduced to fyke nets in the spring there is a total of 1191 fish. These results match our results (see below).

```{r echo=FALSE}
sum_DODGLENS[c(1,10,100,200),]
```

Is it possible that Daisuke's results were not "expanded" by fish counts to include length measurements (or some approxiation) for when multiple fish were binned??? [*Note how his sample sizes are close to the original record numbers.*]



## Biggest Questions for Daisuke

1. What "length data" did you use?
    a. Which file is that?
    a. Were multiple fish in binned lengths expanded to individual lengths? How?
    a. What criteria for inclusion/exclusion did you use?
1. How did you apply the weight-length regressions to ultimately get mean weights at age?
    a. If you converted mean lengths at age to mean weights at age, how did you get your mean lengths (related to ALK question below ... by assigning ages to individual fish or using the ALK to convert mean lengths in the aged sample to the larger sample)?
1. How did you apply the age-length keys to get ages?
    a. Did you assign ages to individual fish or use the ALK to expand the proportions in ages in the aged sample to proportions in the ages in the larger sample (the lengths)?
1. What criteria did you use to identify which weight-length relationship to use (i.e., WBIC_YEAR, WBIC, region, overall)?
1. What criteria did you use to identify which ALK to use (i.e., WBIC_YEAR, WBIC, region, overall)?
1. What criteria did you use to reject a final P and B calculation as being invalid (small n of lengths, small number of ages, gaps in ages, etc.)?
